version: '3.8'

services:
  traefik:
    image: "traefik:v2.10"
    container_name: "traefik"
    command:
      - "--api.insecure=true"
      - "--providers.file.directory=/etc/traefik/conf"
      - "--providers.file.watch=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - "./reverse-proxy/conf:/etc/traefik/conf:ro"
      - "./reverse-proxy/letsencrypt:/letsencrypt"
    networks:
      - ai-agent-net

  n8n:
    image: n8nio/n8n
    container_name: n8n
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - N8N_HOST=${N8N_HOST}
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - WEBHOOK_URL=${WEBHOOK_URL}
      - GENERIC_TIMEZONE=${GENERIC_TIMEZONE}
      - TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
      - TAVILY_API_KEY=${TAVILY_API_KEY}
      - OLLAMA_MODEL=${OLLAMA_MODEL}
      - OLLAMA_EMBEDDING_MODEL=${OLLAMA_EMBEDDING_MODEL}
      - OLLAMA_EMBEDDING_MAX_CHARS=${OLLAMA_EMBEDDING_MAX_CHARS}
      - OLLAMA_PROMPT_MAX_CHARS=${OLLAMA_PROMPT_MAX_CHARS}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL}
      - OLLAMA_API_KEY=${OLLAMA_API_KEY}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - LAZYBONES_WEBHOOK_KEY=${LAZYBONES_WEBHOOK_KEY}
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=false
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.n8n.rule=Host(`${N8N_HOST}`)"
      - "traefik.http.routers.n8n.entrypoints=websecure"
      - "traefik.http.routers.n8n.tls.certresolver=letsencrypt"
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"
    volumes:
      - ./n8n/data:/home/node/.n8n
    depends_on:
      - ollama
      - chroma
    networks:
      - ai-agent-net
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:5678"]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: '1.5G'


  ollama:
    image: ollama/ollama
    container_name: ollama
    restart: unless-stopped
    volumes:
      - ./ollama/data:/root/.ollama
    environment:
      # Рекомендуемая компактная модель для слабого ноутбука.
      # Перед первым запуском внутри контейнера выполните:
      #   ollama pull llama3.2:3b
      - OLLAMA_MODEL=${OLLAMA_MODEL}
      # - OLLAMA_MODEL=llama3.1:8b
      # - OLLAMA_MODEL=mistral:7b
    networks:
      - ai-agent-net
    tty: true
    deploy:
      resources:
        limits:
          memory: '8G'  # Увеличим лимит памяти


  chroma:
    image: chromadb/chroma:0.4.24
    container_name: "chroma"
    restart: unless-stopped
    volumes:
      - "./vector-store/data:/chroma/chroma"
    networks:
      - ai-agent-net
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: '512M'

  # Self-hosted Supabase foundation (step 1): Postgres + pgvector.
  supabase-db:
    image: pgvector/pgvector:pg15
    container_name: supabase-db
    restart: unless-stopped
    environment:
      - POSTGRES_DB=${SUPABASE_DB_NAME:-postgres}
      - POSTGRES_USER=${SUPABASE_DB_USER:-postgres}
      - POSTGRES_PASSWORD=${SUPABASE_DB_PASSWORD:-change-me-strong-password}
    volumes:
      - ./supabase/db/data:/var/lib/postgresql/data
    ports:
      - "54322:5432"
    networks:
      - ai-agent-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${SUPABASE_DB_USER:-postgres} -d ${SUPABASE_DB_NAME:-postgres}"]
      interval: 5s
      timeout: 5s
      retries: 30
      start_period: 30s

  # Idempotent DB bootstrap that runs on every `docker compose up -d`.
  # This avoids manual fixes when DB already exists or when host line-endings differ.
  supabase-db-init:
    image: postgres:15-alpine
    container_name: supabase-db-init
    restart: "no"
    depends_on:
      supabase-db:
        condition: service_healthy
    environment:
      - SUPABASE_DB_NAME=${SUPABASE_DB_NAME:-postgres}
      - SUPABASE_DB_USER=${SUPABASE_DB_USER:-postgres}
      - SUPABASE_DB_PASSWORD=${SUPABASE_DB_PASSWORD:-change-me-strong-password}
    command:
      - sh
      - -ec
      - |
        DB_URL="postgresql://$${SUPABASE_DB_USER}:$${SUPABASE_DB_PASSWORD}@supabase-db:5432/$${SUPABASE_DB_NAME}"
        until pg_isready -h supabase-db -p 5432 -U "$${SUPABASE_DB_USER}" -d "$${SUPABASE_DB_NAME}"; do
          sleep 2
        done
        psql "$$DB_URL" -v ON_ERROR_STOP=1 -v db_pass="$${SUPABASE_DB_PASSWORD}" <<'SQL'
        create extension if not exists pgcrypto;
        create extension if not exists vector;

        select 'create role anon nologin noinherit'
        where not exists (select 1 from pg_roles where rolname = 'anon') \gexec
        select 'create role authenticated nologin noinherit'
        where not exists (select 1 from pg_roles where rolname = 'authenticated') \gexec
        select 'create role service_role nologin noinherit bypassrls'
        where not exists (select 1 from pg_roles where rolname = 'service_role') \gexec

        select 'create role authenticator login noinherit'
        where not exists (select 1 from pg_roles where rolname = 'authenticator') \gexec
        select 'create role supabase_auth_admin login noinherit createrole'
        where not exists (select 1 from pg_roles where rolname = 'supabase_auth_admin') \gexec
        select 'create role supabase_storage_admin login noinherit createrole'
        where not exists (select 1 from pg_roles where rolname = 'supabase_storage_admin') \gexec
        select 'create role supabase_admin login noinherit createrole createdb'
        where not exists (select 1 from pg_roles where rolname = 'supabase_admin') \gexec
        select 'create role dashboard_user login noinherit'
        where not exists (select 1 from pg_roles where rolname = 'dashboard_user') \gexec

        select format('alter role authenticator with password %L', :'db_pass') \gexec
        select format('alter role supabase_auth_admin with password %L', :'db_pass') \gexec
        select format('alter role supabase_storage_admin with password %L', :'db_pass') \gexec
        select format('alter role supabase_admin with password %L', :'db_pass') \gexec
        select format('alter role dashboard_user with password %L', :'db_pass') \gexec

        grant anon, authenticated, service_role to authenticator;

        create schema if not exists auth;
        create schema if not exists storage;
        create schema if not exists graphql_public;
        create schema if not exists realtime;
        create schema if not exists _realtime;
        create schema if not exists supabase_functions;

        alter role supabase_auth_admin set search_path = auth, public;
        alter role supabase_storage_admin set search_path = storage, public;
        alter role supabase_admin set search_path = _realtime, public;
        grant usage, create on schema auth to supabase_auth_admin;
        grant usage, create on schema storage to supabase_storage_admin;
        grant usage, create on schema _realtime to supabase_admin;
        grant usage, create on schema realtime to supabase_admin;
        grant usage on schema public to supabase_auth_admin, supabase_storage_admin, supabase_admin;

        grant usage on schema public to anon, authenticated, service_role;
        grant usage on schema storage to anon, authenticated, service_role;
        grant usage on schema graphql_public to anon, authenticated, service_role;

        create table if not exists public.reports (
          id uuid primary key default gen_random_uuid(),
          user_id text not null,
          report_type text not null default 'daily',
          report_date date not null,
          payload jsonb not null default '{}'::jsonb,
          source text not null default 'mobile_app',
          created_at timestamptz not null default now(),
          updated_at timestamptz not null default now()
        );

        create index if not exists reports_user_date_idx
          on public.reports (user_id, report_date desc);
        create index if not exists reports_type_idx
          on public.reports (report_type);

        create table if not exists public.report_insights (
          id uuid primary key default gen_random_uuid(),
          user_id text not null,
          report_date date not null,
          insight_type text not null,
          summary text not null,
          meta jsonb not null default '{}'::jsonb,
          created_at timestamptz not null default now()
        );

        create index if not exists report_insights_user_date_idx
          on public.report_insights (user_id, report_date desc);

        grant select, insert, update, delete on public.reports to authenticated, service_role;
        grant select, insert, update, delete on public.report_insights to authenticated, service_role;
        SQL
    networks:
      - ai-agent-net

  supabase-auth:
    image: supabase/gotrue:v2.185.0
    container_name: supabase-auth
    restart: unless-stopped
    depends_on:
      supabase-db-init:
        condition: service_completed_successfully
    environment:
      - API_EXTERNAL_URL=${SUPABASE_PUBLIC_URL:-http://localhost:8000}
      - GOTRUE_API_HOST=0.0.0.0
      - GOTRUE_API_PORT=9999
      - GOTRUE_DB_DRIVER=postgres
      - GOTRUE_DB_NAMESPACE=auth
      - GOTRUE_DB_DATABASE_URL=postgres://supabase_auth_admin:${SUPABASE_DB_PASSWORD:-change-me-strong-password}@supabase-db:5432/${SUPABASE_DB_NAME:-postgres}?search_path=auth
      - GOTRUE_SITE_URL=${SUPABASE_SITE_URL:-http://localhost:3000}
      - GOTRUE_URI_ALLOW_LIST=${SUPABASE_ADDITIONAL_REDIRECT_URLS:-}
      - GOTRUE_DISABLE_SIGNUP=${SUPABASE_DISABLE_SIGNUP:-false}
      - GOTRUE_JWT_ADMIN_ROLES=service_role
      - GOTRUE_JWT_AUD=authenticated
      - GOTRUE_JWT_DEFAULT_GROUP_NAME=authenticated
      - GOTRUE_JWT_EXP=${SUPABASE_JWT_EXP:-3600}
      - GOTRUE_JWT_SECRET=${SUPABASE_JWT_SECRET:-replace-with-very-long-random-jwt-secret-at-least-32-chars}
      - GOTRUE_EXTERNAL_EMAIL_ENABLED=true
      - GOTRUE_MAILER_AUTOCONFIRM=${SUPABASE_MAILER_AUTOCONFIRM:-true}
      - GOTRUE_SMTP_HOST=${SUPABASE_SMTP_HOST:-}
      - GOTRUE_SMTP_PORT=${SUPABASE_SMTP_PORT:-587}
      - GOTRUE_SMTP_USER=${SUPABASE_SMTP_USER:-}
      - GOTRUE_SMTP_PASS=${SUPABASE_SMTP_PASS:-}
      - GOTRUE_SMTP_ADMIN_EMAIL=${SUPABASE_SMTP_ADMIN_EMAIL:-}
      - GOTRUE_SMTP_SENDER_NAME=${SUPABASE_SMTP_SENDER_NAME:-LazyBones}
    networks:
      - ai-agent-net

  supabase-rest:
    image: postgrest/postgrest:v14.3
    container_name: supabase-rest
    restart: unless-stopped
    depends_on:
      supabase-db-init:
        condition: service_completed_successfully
    environment:
      - PGRST_DB_URI=postgres://authenticator:${SUPABASE_DB_PASSWORD:-change-me-strong-password}@supabase-db:5432/${SUPABASE_DB_NAME:-postgres}
      - PGRST_DB_SCHEMAS=public,storage,graphql_public
      - PGRST_DB_ANON_ROLE=anon
      - PGRST_JWT_SECRET=${SUPABASE_JWT_SECRET:-replace-with-very-long-random-jwt-secret-at-least-32-chars}
      - PGRST_DB_USE_LEGACY_GUCS=false
      - PGRST_APP_SETTINGS_JWT_SECRET=${SUPABASE_JWT_SECRET:-replace-with-very-long-random-jwt-secret-at-least-32-chars}
      - PGRST_APP_SETTINGS_JWT_EXP=${SUPABASE_JWT_EXP:-3600}
    networks:
      - ai-agent-net

  supabase-realtime:
    image: supabase/realtime:v2.72.0
    container_name: supabase-realtime
    restart: unless-stopped
    depends_on:
      supabase-db-init:
        condition: service_completed_successfully
    environment:
      - APP_NAME=${SUPABASE_REALTIME_APP_NAME:-realtime}
      - RLIMIT_NOFILE=1048576
      - PORT=4000
      - DB_HOST=supabase-db
      - DB_PORT=5432
      - DB_NAME=${SUPABASE_DB_NAME:-postgres}
      - DB_USER=supabase_admin
      - DB_PASSWORD=${SUPABASE_DB_PASSWORD:-change-me-strong-password}
      - DB_AFTER_CONNECT_QUERY=SET search_path TO _realtime
      - API_JWT_SECRET=${SUPABASE_JWT_SECRET:-replace-with-very-long-random-jwt-secret-at-least-32-chars}
      - SECRET_KEY_BASE=${SUPABASE_SECRET_KEY_BASE:-replace-with-long-random-secret-key-base}
      - ERL_AFLAGS=-proto_dist inet_tcp
      - SEED_SELF_HOST=true
    networks:
      - ai-agent-net

  supabase-storage:
    image: supabase/storage-api:v1.37.1
    container_name: supabase-storage
    restart: unless-stopped
    depends_on:
      supabase-db-init:
        condition: service_completed_successfully
      supabase-rest:
        condition: service_started
      supabase-imgproxy:
        condition: service_started
    environment:
      - ANON_KEY=${SUPABASE_ANON_KEY:-replace-with-actual-anon-jwt}
      - SERVICE_KEY=${SUPABASE_SERVICE_ROLE_KEY:-replace-with-actual-service-role-jwt}
      - POSTGREST_URL=http://supabase-rest:3000
      - PGRST_JWT_SECRET=${SUPABASE_JWT_SECRET:-replace-with-very-long-random-jwt-secret-at-least-32-chars}
      - DATABASE_URL=postgres://supabase_storage_admin:${SUPABASE_DB_PASSWORD:-change-me-strong-password}@supabase-db:5432/${SUPABASE_DB_NAME:-postgres}
      - FILE_SIZE_LIMIT=${SUPABASE_STORAGE_FILE_SIZE_LIMIT:-52428800}
      - STORAGE_BACKEND=file
      - FILE_STORAGE_BACKEND_PATH=/var/lib/storage
      - TENANT_ID=stub
      - REGION=stub
      - GLOBAL_S3_BUCKET=stub
      - ENABLE_IMAGE_TRANSFORMATION=true
      - IMGPROXY_URL=http://supabase-imgproxy:5001
    volumes:
      - ./supabase/storage:/var/lib/storage
    networks:
      - ai-agent-net

  supabase-imgproxy:
    image: darthsim/imgproxy:v3.30.1
    container_name: supabase-imgproxy
    restart: unless-stopped
    environment:
      - IMGPROXY_BIND=0.0.0.0:5001
      - IMGPROXY_ENABLE_WEBP_DETECTION=true
    networks:
      - ai-agent-net

  supabase-meta:
    image: supabase/postgres-meta:v0.95.2
    container_name: supabase-meta
    restart: unless-stopped
    depends_on:
      supabase-db-init:
        condition: service_completed_successfully
    environment:
      - PG_META_PORT=8080
      - PG_META_DB_HOST=supabase-db
      - PG_META_DB_PORT=5432
      - PG_META_DB_NAME=${SUPABASE_DB_NAME:-postgres}
      - PG_META_DB_USER=${SUPABASE_DB_USER:-postgres}
      - PG_META_DB_PASSWORD=${SUPABASE_DB_PASSWORD:-change-me-strong-password}
    networks:
      - ai-agent-net

  supabase-functions:
    image: supabase/edge-runtime:v1.70.0
    container_name: supabase-functions
    restart: unless-stopped
    environment:
      - JWT_SECRET=${SUPABASE_JWT_SECRET:-replace-with-very-long-random-jwt-secret-at-least-32-chars}
      - SUPABASE_URL=http://supabase-kong:8000
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY:-replace-with-actual-anon-jwt}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY:-replace-with-actual-service-role-jwt}
      - VERIFY_JWT=${SUPABASE_FUNCTIONS_VERIFY_JWT:-false}
    command:
      - start
      - --main-service
      - /home/deno/functions/main
    volumes:
      - ./supabase/functions:/home/deno/functions:ro
    networks:
      - ai-agent-net

  supabase-kong:
    image: kong:2.8.1
    container_name: supabase-kong
    restart: unless-stopped
    depends_on:
      - supabase-auth
      - supabase-rest
      - supabase-realtime
      - supabase-storage
      - supabase-meta
      - supabase-functions
    environment:
      - KONG_DATABASE=off
      - KONG_DECLARATIVE_CONFIG=/home/kong/kong.yml
      - KONG_DNS_ORDER=LAST,A,CNAME
      - KONG_PLUGINS=request-transformer,cors,key-auth,acl,basic-auth
      - KONG_PROXY_ACCESS_LOG=/dev/stdout
      - KONG_ADMIN_ACCESS_LOG=/dev/stdout
      - KONG_PROXY_ERROR_LOG=/dev/stderr
      - KONG_ADMIN_ERROR_LOG=/dev/stderr
      - KONG_ADMIN_LISTEN=0.0.0.0:8001
    volumes:
      - ./supabase/kong/kong.yml:/home/kong/kong.yml:ro
    ports:
      - "8000:8000"
    networks:
      - ai-agent-net

  supabase-studio:
    image: supabase/studio:2026.01.27-sha-6aa59ff
    container_name: supabase-studio
    restart: unless-stopped
    depends_on:
      - supabase-meta
      - supabase-kong
    environment:
      - STUDIO_PG_META_URL=http://supabase-meta:8080
      - POSTGRES_PASSWORD=${SUPABASE_DB_PASSWORD:-change-me-strong-password}
      - DEFAULT_ORGANIZATION=${SUPABASE_STUDIO_DEFAULT_ORG:-LazyBones}
      - DEFAULT_PROJECT=${SUPABASE_STUDIO_DEFAULT_PROJECT:-LazyBones Local}
      - SUPABASE_URL=http://supabase-kong:8000
      - SUPABASE_PUBLIC_URL=${SUPABASE_PUBLIC_URL:-http://localhost:8000}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY:-replace-with-actual-anon-jwt}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_ROLE_KEY:-replace-with-actual-service-role-jwt}
      - LOGFLARE_API_KEY=${SUPABASE_LOGFLARE_API_KEY:-}
      - LOGFLARE_URL=${SUPABASE_LOGFLARE_URL:-}
      - NEXT_PUBLIC_ENABLE_LOGS=true
    ports:
      - "3000:3000"
    networks:
      - ai-agent-net

networks:
  ai-agent-net:
    driver: bridge
